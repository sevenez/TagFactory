# 群体中心功能技术文档

## 1. 功能实现原理

### 1.1 功能概述

群体中心功能允许用户通过选择多个标签创建群体，并从数据库中高效检索相关数据。该功能主要包括：

- 群体创建：用户可以通过选择多个标签创建群体
- 群体管理：查看、编辑、删除群体
- 群体数据检索：根据特定群体从数据库中检索相关数据
- 标签类型验证：确保同一群体内的标签类型保持一致

### 1.2 核心实现原理

1. **标签选择机制**：
   - 用户选择标签时，前端会验证标签类型是否与群体实体类型一致
   - 后端API也会进行相同的验证，确保数据一致性

2. **数据存储结构**：
   - 使用三个主要数据表存储群体相关数据
   - 采用外键约束确保数据完整性
   - 使用索引优化查询性能

3. **API设计**：
   - 遵循RESTful规范
   - 支持分页、排序和过滤
   - 实现完善的错误处理机制

## 2. API接口设计

### 2.1 创建群体

- **URL**：`POST /groups`
- **方法**：POST
- **参数**：
  - `name`：群体名称（必填）
  - `entity_type`：实体类型（CUSTOMER/PRODUCT/SELLER，必填）
  - `method`：创建方式（RULE/BEHAVIOR/IMPORT，必填）
  - `tags`：标签列表JSON字符串，包含tag_code、tag_value和operator（可选）
  - `description`：群体描述（可选）
- **返回值**：
  ```json
  {
    "group_id": "1",
    "name": "测试群体",
    "method": "RULE",
    "rule": "TAG_001 AND TAG_002",
    "users": 0,
    "status": "ENABLED",
    "created_at": "2023-01-01T00:00:00",
    "updated_at": "2023-01-01T00:00:00",
    "creator": "演示帐号"
  }
  ```

### 2.2 获取群体列表

- **URL**：`GET /groups`
- **方法**：GET
- **参数**：
  - `status`：状态过滤（ENABLED/DISABLED，可选）
  - `method`：创建方式过滤（RULE/BEHAVIOR/IMPORT，可选）
  - `entity_type`：实体类型过滤（CUSTOMER/PRODUCT/SELLER，可选）
  - `name`：群体名称模糊搜索（可选）
  - `skip`：分页偏移量（默认0，可选）
  - `limit`：每页数量（默认100，可选）
  - `sort_by`：排序字段（默认create_time，可选）
  - `sort_order`：排序方向（asc/desc，默认desc，可选）
- **返回值**：
  ```json
  {
    "data": [
      {
        "group_id": "1",
        "name": "测试群体",
        "method": "RULE",
        "rule": "TAG_001 AND TAG_002",
        "users": 0,
        "status": "ENABLED",
        "created_at": "2023-01-01T00:00:00",
        "updated_at": "2023-01-01T00:00:00",
        "creator": "演示帐号"
      }
    ],
    "total": 1,
    "page": 1,
    "page_size": 100,
    "total_pages": 1
  }
  ```

### 2.3 获取群体详情

- **URL**：`GET /groups/{group_id}`
- **方法**：GET
- **参数**：
  - `group_id`：群体ID（必填）
- **返回值**：
  ```json
  {
    "group_id": "1",
    "name": "测试群体",
    "method": "RULE",
    "rule": "TAG_001 AND TAG_002",
    "users": 0,
    "status": "ENABLED",
    "created_at": "2023-01-01T00:00:00",
    "updated_at": "2023-01-01T00:00:00",
    "creator": "演示帐号"
  }
  ```

### 2.4 获取群体标签

- **URL**：`GET /groups/{group_id}/tags`
- **方法**：GET
- **参数**：
  - `group_id`：群体ID（必填）
- **返回值**：
  ```json
  [
    {
      "tag_code": "TAG_001",
      "tag_value": "",
      "operator": "AND",
      "create_time": "2023-01-01T00:00:00"
    },
    {
      "tag_code": "TAG_002",
      "tag_value": "",
      "operator": "AND",
      "create_time": "2023-01-01T00:00:00"
    }
  ]
  ```

### 2.5 获取群体实体

- **URL**：`GET /groups/{group_id}/entities`
- **方法**：GET
- **参数**：
  - `group_id`：群体ID（必填）
  - `skip`：分页偏移量（默认0，可选）
  - `limit`：每页数量（默认100，可选）
- **返回值**：
  ```json
  [
    {
      "entity_id": "C001",
      "entity_type": "CUSTOMER",
      "add_time": "2023-01-01T00:00:00"
    }
  ]
  ```

### 2.6 获取群体统计信息

- **URL**：`GET /groups/{group_id}/stats`
- **方法**：GET
- **参数**：
  - `group_id`：群体ID（必填）
- **返回值**：
  ```json
  {
    "group_id": "1",
    "group_name": "测试群体",
    "entity_count": 0,
    "tag_count": 2,
    "entity_type": "CUSTOMER",
    "status": "启用",
    "create_time": "2023-01-01T00:00:00"
  }
  ```

## 3. 数据库表结构设计

### 3.1 群体定义表（group_definition）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| group_id | INT | PRIMARY KEY, AUTO_INCREMENT | 群体ID |
| group_code | VARCHAR(50) | UNIQUE, NOT NULL | 群体编码 |
| group_name | VARCHAR(50) | NOT NULL | 群体显示名 |
| entity_type | ENUM('CUSTOMER', 'PRODUCT', 'SELLER') | NOT NULL | 群体归属实体类型 |
| create_method | ENUM('RULE', 'BEHAVIOR', 'IMPORT') | NOT NULL, DEFAULT 'RULE' | 创建方式 |
| status | TINYINT(1) | DEFAULT 1 | 状态（1-启用 0-停用） |
| entity_count | INT | DEFAULT 0 | 群体包含实体数量 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| creator | VARCHAR(50) | DEFAULT 'system' | 创建人 |
| description | VARCHAR(255) | | 群体描述 |

### 3.2 群体标签关系表（group_tag_relation）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| group_id | INT | NOT NULL, FOREIGN KEY | 关联group_definition.group_id |
| tag_code | VARCHAR(50) | NOT NULL, FOREIGN KEY | 关联tag_definition.tag_code |
| tag_value | VARCHAR(255) | NOT NULL | 标签值 |
| operator | ENUM('AND', 'OR') | DEFAULT 'AND' | 标签间逻辑关系 |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 3.3 群体实体关系表（group_entity_relation）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| group_id | INT | NOT NULL, FOREIGN KEY | 关联group_definition.group_id |
| entity_id | CHAR(17) | NOT NULL | 实体ID |
| entity_type | ENUM('CUSTOMER', 'PRODUCT', 'SELLER') | NOT NULL | 实体类型 |
| add_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 加入时间 |

### 3.4 索引设计

| 表名 | 索引名 | 索引字段 | 类型 | 描述 |
|------|--------|----------|------|------|
| group_definition | idx_group_entity_type_status | entity_type, status | 联合索引 | 优化按实体类型和状态查询群体 |
| group_tag_relation | uk_group_tag_value | group_id, tag_code, tag_value | 唯一索引 | 确保同一群体内的标签值组合唯一 |
| group_tag_relation | idx_group_id | group_id | 普通索引 | 优化按群体ID查询标签 |
| group_tag_relation | idx_tag_code | tag_code | 普通索引 | 优化按标签代码查询群体 |
| group_entity_relation | uk_group_entity | group_id, entity_id | 唯一索引 | 确保一个实体对一个群体只有一个记录 |
| group_entity_relation | idx_group_id | group_id | 普通索引 | 优化按群体ID查询实体 |
| group_entity_relation | idx_entity_id | entity_id | 普通索引 | 优化按实体ID查询群体 |
| group_entity_relation | idx_entity_type | entity_type | 普通索引 | 优化按实体类型查询群体 |
| group_entity_relation | idx_group_entity_type | group_id, entity_type | 联合索引 | 优化按群体ID和实体类型查询群体实体关系 |

## 4. 前端组件设计说明

### 4.1 组件概述

前端组件使用Vue 3的Composition API开发，主要包括：

- 群体创建表单
- 标签选择器
- 群体列表展示

### 4.2 组件结构

```vue
<template>
  <div class="card">
    <!-- 群体创建表单 -->
    <div class="create-group-form">
      <!-- 表单字段 -->
      <!-- 标签选择器 -->
    </div>
    
    <!-- 群体列表 -->
    <div class="group-list">
      <!-- 群体列表表格 -->
    </div>
  </div>
</template>
```

### 4.3 核心功能实现

1. **标签选择器**：
   - 支持按实体类型过滤标签
   - 支持关键词搜索标签
   - 实时显示已选择标签
   - 提供标签移除功能

2. **表单验证**：
   - 验证群体名称是否为空
   - 验证是否至少选择一个标签
   - 验证所有选择的标签类型是否一致
   - 验证标签类型是否与群体实体类型一致

3. **响应式设计**：
   - 适配不同屏幕尺寸
   - 移动端友好的布局

### 4.4 交互流程

1. 用户选择实体类型
2. 系统加载对应类型的标签
3. 用户搜索并选择标签
4. 系统验证标签类型一致性
5. 用户填写群体基本信息
6. 用户提交表单
7. 系统创建群体并保存标签关系
8. 系统更新群体列表

## 5. 测试用例及验证方法

### 5.1 前端测试用例

| 测试用例 | 测试步骤 | 预期结果 | 验证方法 |
|----------|----------|----------|----------|
| 标签类型验证 | 1. 选择实体类型为CUSTOMER<br>2. 尝试选择PRODUCT类型的标签 | 显示错误提示："标签类型必须与群体实体类型一致" | 手动测试 |
| 表单必填项验证 | 1. 不填写群体名称<br>2. 点击创建按钮 | 显示错误提示："请输入群体名称" | 手动测试 |
| 标签选择功能 | 1. 选择多个标签<br>2. 查看已选择标签列表 | 已选择标签列表显示正确 | 手动测试 |
| 响应式布局 | 1. 调整浏览器窗口大小<br>2. 查看组件布局 | 组件布局自适应不同屏幕尺寸 | 手动测试 |

### 5.2 后端测试用例

| 测试用例 | 测试步骤 | 预期结果 | 验证方法 |
|----------|----------|----------|----------|
| 创建群体API | 1. 调用POST /groups API<br>2. 传递有效的标签数据 | 返回状态码200，群体创建成功 | 自动化测试 |
| 标签类型验证API | 1. 调用POST /groups API<br>2. 传递类型不一致的标签 | 返回状态码400，错误提示："标签类型与群体实体类型不一致" | 自动化测试 |
| 获取群体列表API | 1. 调用GET /groups API<br>2. 传递分页参数 | 返回包含分页信息的群体列表 | 自动化测试 |
| 获取群体详情API | 1. 调用GET /groups/{group_id} API<br>2. 传递有效的group_id | 返回群体详情信息 | 自动化测试 |

### 5.3 集成测试用例

| 测试用例 | 测试步骤 | 预期结果 | 验证方法 |
|----------|----------|----------|----------|
| 完整群体创建流程 | 1. 前端填写群体信息<br>2. 选择标签<br>3. 提交表单<br>4. 查看群体列表 | 群体创建成功，列表显示新群体 | 手动测试 |
| 群体数据一致性 | 1. 创建群体<br>2. 查看数据库中的数据 | 数据库中存储的群体数据与前端输入一致 | 手动测试 |

### 5.4 验证方法

1. **手动测试**：通过浏览器访问前端页面，手动操作验证功能
2. **自动化测试**：运行测试脚本`backend/test/test_groups.py`验证API功能
3. **数据库验证**：直接查询数据库，验证数据一致性

## 6. 代码结构

### 6.1 后端代码结构

```
backend/
├── routers/
│   └── groups.py          # 群体相关API路由
├── models/
│   └── group.py           # 群体相关数据模型
└── test/
    └── test_groups.py     # 群体功能测试脚本
```

### 6.2 前端代码结构

```
frontend/
└── src/
    ├── pages/
    │   └── Groups.vue     # 群体中心页面组件
    └── api/
        └── client.js      # API客户端
```

## 7. 性能优化

1. **数据库优化**：
   - 添加适当的索引，优化查询性能
   - 使用外键约束确保数据完整性
   - 实现触发器，确保同一群体内的标签类型一致

2. **API优化**：
   - 实现分页功能，避免一次性返回大量数据
   - 支持排序和过滤，提高数据检索效率
   - 使用缓存机制，减少数据库查询次数

3. **前端优化**：
   - 实现虚拟滚动，优化大量数据展示
   - 使用异步加载，提高页面响应速度
   - 实现防抖和节流，减少API调用次数

## 8. 安全性考虑

1. **数据验证**：
   - 前端和后端都实现数据验证
   - 验证标签类型一致性
   - 验证必填字段

2. **错误处理**：
   - 实现完善的错误处理机制
   - 返回清晰的错误提示信息
   - 记录详细的错误日志

3. **权限控制**：
   - 实现基于角色的访问控制
   - 限制敏感操作的权限

4. **数据安全**：
   - 使用参数化查询，防止SQL注入
   - 加密敏感数据
   - 实现数据备份和恢复机制

## 9. 部署说明

### 9.1 环境要求

- Python 3.8+
- FastAPI
- Vue 3
- MySQL 8.0+

### 9.2 部署步骤

1. **数据库部署**：
   - 执行SQL脚本`Documents/SQL/group_center.sql`创建数据库表
   - 导入模拟数据（可选）

2. **后端部署**：
   - 安装依赖：`pip install -r requirements.txt`
   - 启动后端服务：`uvicorn backend.main:app --reload`

3. **前端部署**：
   - 安装依赖：`npm install`
   - 构建前端项目：`npm run build`
   - 部署构建产物到Web服务器

### 9.3 服务访问地址

- 后端API：http://localhost:8000
- 前端页面：http://localhost:5173

## 10. 维护与升级

### 10.1 日志管理

- 系统记录详细的操作日志
- 日志包括API调用、错误信息等
- 定期清理过期日志

### 10.2 性能监控

- 监控API响应时间
- 监控数据库查询性能
- 监控系统资源使用情况

### 10.3 升级流程

1. 备份数据库
2. 部署新版本代码
3. 执行数据库迁移（如果需要）
4. 启动服务
5. 验证功能正常

## 11. 总结

群体中心功能实现了从数据库获取数据的相关需求，包括：

- 开发了用户界面组件，允许用户通过选择多个标签创建群体
- 实现了严格的前端验证逻辑，确保同一群体内的标签类型保持一致
- 实现了后端API接口，根据用户选择的特定群体从数据库中高效检索并返回相关数据
- 包含了适当的分页、排序和过滤功能
- API设计符合RESTful规范
- 实现了完善的错误处理机制

该功能符合需求规格，代码结构合理，数据库设计高效，并提供了完整的技术文档说明实现细节。
