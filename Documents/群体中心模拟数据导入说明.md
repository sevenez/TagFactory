# 群体中心模拟数据导入说明

## 一、导入顺序

由于存在外键约束，必须按照以下顺序导入数据：

1. **第一步：导入群体定义数据**
   - 文件：`group_definition.csv`
   - 表名：`group_definition`
   - 说明：定义了所有群体的基本信息，是其他表的基础

2. **第二步：导入群体标签关系数据**
   - 文件：`temp_group_tag_relation.csv`
   - 表名：`temp_group_tag_relation`（临时表）
   - 说明：关联群体与标签，使用group_code替代group_id，文件名与临时表名称一致

3. **第三步：导入群体实体关系数据**
   - 文件：`temp_group_entity_relation.csv`
   - 表名：`temp_group_entity_relation`（临时表）
   - 说明：关联群体与实体，使用group_code替代group_id，文件名与临时表名称一致

4. **第四步：执行关联插入**
   - 将临时表数据通过group_code关联插入到正式表
   - 更新群体定义表中的entity_count字段
   - 删除临时表

## 二、导入方法

### 推荐导入方法：解决group_id不匹配问题

当导入group_definition表后，group_id是自增生成的，可能与CSV文件中预期的group_id不一致，此时需要使用以下方法：

1. 登录MySQL数据库
2. 切换到tagfactory数据库：`USE tagfactory;`
3. 禁用外键约束：`SET FOREIGN_KEY_CHECKS = 0;`
4. 创建临时表：
   ```sql
   CREATE TABLE IF NOT EXISTS temp_group_tag_relation (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     group_code VARCHAR(50) NOT NULL,
     tag_code VARCHAR(50) NOT NULL,
     tag_value VARCHAR(255) NOT NULL,
     operator ENUM('AND', 'OR') DEFAULT 'AND'
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
   
   CREATE TABLE IF NOT EXISTS temp_group_entity_relation (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     group_code VARCHAR(50) NOT NULL,
     entity_id CHAR(17) NOT NULL,
     entity_type ENUM('CUSTOMER', 'PRODUCT', 'SELLER') NOT NULL
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
   ```
5. 使用我们已经生成好的新CSV文件（无需手动修改）：
   - `temp_group_tag_relation.csv`：已将group_id替换为group_code，与临时表名称一致
   - `temp_group_entity_relation.csv`：已将group_id替换为group_code，与临时表名称一致
6. 导入新CSV数据到临时表：
   ```sql
   LOAD DATA INFILE 'e:/AIcodes/Case/TagFactory/Documents/模拟数据/temp_group_tag_relation.csv'
   INTO TABLE temp_group_tag_relation
   FIELDS TERMINATED BY ','
   ENCLOSED BY '"'
   LINES TERMINATED BY '\r\n'
   IGNORE 1 ROWS
   (group_code, tag_code, tag_value, operator);
   
   LOAD DATA INFILE 'e:/AIcodes/Case/TagFactory/Documents/模拟数据/temp_group_entity_relation.csv'
   INTO TABLE temp_group_entity_relation
   FIELDS TERMINATED BY ','
   ENCLOSED BY '"'
   LINES TERMINATED BY '\r\n'
   IGNORE 1 ROWS
   (group_code, entity_id, entity_type);
   ```
7. 通过group_code关联，将数据插入到正式表：
   ```sql
   INSERT INTO group_tag_relation (group_id, tag_code, tag_value, operator)
   SELECT g.group_id, t.tag_code, t.tag_value, t.operator
   FROM temp_group_tag_relation t
   JOIN group_definition g ON t.group_code = g.group_code;
   
   INSERT INTO group_entity_relation (group_id, entity_id, entity_type)
   SELECT g.group_id, t.entity_id, t.entity_type
   FROM temp_group_entity_relation t
   JOIN group_definition g ON t.group_code = g.group_code;
   ```
8. 删除临时表：
   ```sql
   DROP TABLE IF EXISTS temp_group_tag_relation;
   DROP TABLE IF EXISTS temp_group_entity_relation;
   ```
9. 更新group_definition表中的entity_count字段：
   ```sql
   UPDATE group_definition g
   SET entity_count = (
     SELECT COUNT(*) FROM group_entity_relation WHERE group_id = g.group_id
   );
   ```
10. 启用外键约束：`SET FOREIGN_KEY_CHECKS = 1;`

## 三、注意事项

1. 确保MySQL服务器已启用`secure_file_priv`选项，或使用相对路径
2. 导入前确保所有表已创建（执行`group_center.sql`脚本）
3. 如遇到权限问题，可使用`GRANT FILE ON *.* TO 'username'@'localhost';`授予文件权限
4. CSV文件中的日期时间字段会自动使用当前时间，无需手动设置
5. **重要**：group_id是自增生成的，可能与CSV文件中预期的不一致，建议使用上述方法导入
6. 导入完成后，可使用以下语句验证数据完整性：
   ```sql
   SELECT COUNT(*) FROM group_definition; -- 应返回20
   SELECT COUNT(*) FROM group_tag_relation; -- 应返回41
   SELECT COUNT(*) FROM group_entity_relation; -- 应返回162
   ```

## 四、数据说明

### 群体定义数据
- 包含20个群体定义
- 覆盖用户、商品、商家三种实体类型
- 支持RULE、BEHAVIOR、IMPORT三种创建方式
- 包含启用和禁用状态的群体

### 群体标签关系数据
- 包含41条标签关系
- 支持单标签和多标签组合
- 包含AND和OR两种逻辑运算符
- 确保同一群体内的标签类型一致

### 群体实体关系数据
- 包含162条实体关系
- 覆盖用户、商品、商家三种实体类型
- 支持同一实体属于多个群体
- 每个群体包含多个实体

## 五、常见问题解决

### 1. 外键约束错误
   - 错误信息：`1452 - Cannot add or update a child row: a foreign key constraint fails`
   - 解决方法：
     - 确保导入顺序正确
     - 如仍有问题，可先禁用外键约束再导入

### 2. 数据格式错误
   - 错误信息：`1265 - Data truncated for column`
   - 解决方法：
     - 确保CSV文件的编码格式为UTF-8
     - 检查字段分隔符和文本限定符设置
     - 确保数据类型与表结构一致

### 3. 文件路径错误
   - 错误信息：`1045 - Access denied for user` 或 `2 - No such file or directory`
   - 解决方法：
     - 使用绝对路径或相对路径
     - 确保MySQL服务器有权限访问该文件
     - 检查文件权限设置

### 4. 重复数据错误
   - 错误信息：`1062 - Duplicate entry 'xxx' for key 'xxx'`
   - 解决方法：
     ```sql
     DELETE FROM group_entity_relation;
     DELETE FROM group_tag_relation;
     DELETE FROM group_definition;
     ```
     然后重新导入所有数据

### 5. 权限错误
   - 错误信息：`1045 - Access denied for user 'xxx'@'localhost' (using password: YES)`
   - 解决方法：
     - 检查用户名和密码是否正确
     - 确保用户有足够的权限访问数据库
     - 如需要导入文件，确保用户有FILE权限

### 6. secure_file_priv限制
   - 错误信息：`1290 - The MySQL server is running with the --secure-file-priv option so it cannot execute this statement`
   - 解决方法：
     - 将CSV文件移动到secure_file_priv指定的目录
     - 修改MySQL配置文件，调整secure_file_priv设置
     - 使用MySQL客户端工具手动导入

按照上述说明导入数据，即可顺利完成群体中心模拟数据的导入。